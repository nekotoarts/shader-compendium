<!DOCTYPE html>
<html lang="en">
	<head>
		
<!--KaTeX-->
<link
	rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
	integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
	crossorigin="anonymous"
/>
<script
	defer
	src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
	integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4"
	crossorigin="anonymous"
></script>
<script
	defer
	src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
	integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa"
	crossorigin="anonymous"
></script>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		renderMathInElement(document.body, {
			// customised options
			// • auto-render specific keys, e.g.:
			delimiters: [
				{ left: "$$", right: "$$", display: true },
				{ left: "$", right: "$", display: false },
				{ left: "\\(", right: "\\)", display: false },
				{ left: "\\[", right: "\\]", display: true },
			],
			// • rendering keys, e.g.:
			throwOnError: false,
		});
	});
</script>

<!-- GLSL Canvas -->
<script
	type="text/javascript"
	src="https://unpkg.com/glsl-canvas-js/dist/umd/glsl-canvas.min.js"
></script>

<!-- Jekyll Chapterbook guy took out syntax highlighting idky -->
<link rel="stylesheet" href="/shader-compendium/assets/gitbook/rouge/nekoto_theme.css">

<meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Jos Stam Advection Scheme · Shader Compendium</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="A collection of chapters to help you better understand the world of shaders">

<meta name="generator" content="Jekyll (using jekyll-chapterbook theme)"><meta name="author" content="NekotoArts"><link rel="stylesheet" href="/shader-compendium/assets/gitbook/style.css">
<link rel="stylesheet" href="/shader-compendium/assets/gitbook/gitbook-plugin-fontsettings/website.css"><!--
  <link rel="stylesheet" href="/shader-compendium/assets/gitbook/gitbook-plugin-search-pro/search.css">
  <link rel="stylesheet" href="/shader-compendium/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">
  <link rel="stylesheet" href="/shader-compendium/assets/gitbook/rouge/nekoto_theme.css">
  --><link rel="stylesheet" href="/shader-compendium/assets/gitbook/custom.css">
<link rel="stylesheet" href="/shader-compendium/assets/chapterbook/chapterbook.css">

<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<!--
<link
  rel="apple-touch-icon-precomposed"
  sizes="152x152"
  href="/shader-compendium/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
-->
  
<link
  rel="shortcut icon"
  href="/shader-compendium/assets/gitbook/images/favicon.ico"
  type="image/x-icon">


<link rel="stylesheet" href="/shader-compendium/assets/extra.css">



<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
		<link rel="canonical" href="https://nekotoarts.github.io/shader-compendium/stam-advection.html" />
		  
		<link rel="prev" href="/shader-compendium/helmholtz-hodge-decomposition.html" />
		 
		<link rel="next" href="/shader-compendium/references.html" />
		 
	</head>
	<body>
		<div class="book">
			
  <div class="book-summary">
    <nav role="navigation">
      <ul class="summary chapter-summary">

        
          
            
            
            
            <li class="chapter ">
              <a href="/shader-compendium/index.html" class="">The Shader Compendium</a>
            </li>
          
          <li class="divider"></li>
        

        



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/book.html">
              
              Book Information
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/contents.html">
              
              Table of Contents
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          
            <li class="header ">
              
              Part 1: The basics
              
            </li>
          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/what-are-shaders.html">
              
                1.
              
              What are Shaders?
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/gpu-design.html">
              
                2.
              
              The GPU Design
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          
            <li class="header ">
              
              Part 2: Realtime rendering
              
            </li>
          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/rendering-equation.html">
              
                3.
              
              The Rendering Equation
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/solving-rendering-equation.html">
              
                4.
              
              Solving the Rendering Equation
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/rasterization.html">
              
                5.
              
              Rasterization
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          

          
            <li class="header ">
              
              Part 6: Gpu fluids
              
            </li>
          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/navier-stokes-finite-difference.html">
              
                6.
              
              Navier-Stokes Equations and FDM
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/fluids-high-level-solution.html">
              
                7.
              
              High-Level Solution Overview
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/helmholtz-hodge-decomposition.html">
              
                8.
              
              Helmholtz-Hodge Decomposition
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            














          

          

          

          

          
            <li class="chapter active">
          

            <a href="/shader-compendium/stam-advection.html">
              
                9.
              
              Jos Stam Advection Scheme
            </a>

            
              
                <ul><li><a href="#classical-advection-scheme">Classical Advection Scheme</a><ul><li><a href="#issues-with-classical-advection-scheme">Issues with Classical Advection Scheme</a></li></ul></li><li><a href="#stams-advection-scheme">Stam’s Advection Scheme</a></li></ul>

              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
              














            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/references.html">
              
              References
            </a>

            
              
            
          </li>

          



















  
  


















        

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

        
          <li class="divider"></li>
          
            
            
            
            <li class="chapter ">
              <a href="/shader-compendium/outline.html" class="">Book Outline</a>
            </li>
          
            
            
            
            <li class="chapter ">
              <a href="https://github.com/nekotoarts/shader-compendium/" class="">Star on GitHub</a>
            </li>
          
        

      </ul>
    </nav>
  </div>
  

			<div class="book-body">
				<div class="book-header" role="navigation">
					
					<a
						href="https://github.com/nekotoarts/shader-compendium/edit/main/_chapters/060-GPU-fluids/040-jos-stam-advection-scheme.md"
						target="_blank"
						title="Edit on GitHub"
						class="github-edit-link"
					>
						<i class="fa fa-github"></i>
					</a>
					
					<h1>
						<a href="/shader-compendium/index.html"
							>Shader Compendium</a
						>
					</h1>
				</div>
				<!-- .book-header -->

				<div class="body-inner">
					<!-- introduce per-page mermaid support -->
					<!--  -->
					<div class="page-wrapper" tabindex="-1" role="main">
						<div
							class="page-inner "
						>
							 




  <nav aria-label="Breadcrumb" class="breadcrumb markdown-section">
    <ul>
      
        
          <li>
              
              <a href="/shader-compendium/book.html">
            
              <img class="book-icon" src="/shader-compendium/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
              Book
            
              </a>
            
          </li>
      

      
        
        <li >
          
            <a href="/shader-compendium/contents.html">
          
            Contents
          
            </a>
          
        </li>
      

      

      
        

          
            
              <li class="breadcrumb-part">
                
                Part 6: Gpu fluids
                
              </li>
            
          

          
            <li class="no-arrow">
              Chapter 9.
            </li>
          

        
      
    </ul>
  </nav>

  
    <h1
      id="stam-advection"
      data-level="1.1"
      class="heading-chapter-title no_toc">Jos Stam Advection Scheme</h1>
  


<section class="normal markdown-section">

  

  
    
    

    
      <div class="page-toc">
        <div class="page-toc-heading">
          In this chapter:
          <ul><li><a href="#classical-advection-scheme">Classical Advection Scheme</a><ul><li><a href="#issues-with-classical-advection-scheme">Issues with Classical Advection Scheme</a></li></ul></li><li><a href="#stams-advection-scheme">Stam’s Advection Scheme</a></li></ul>
        </div>
      </div>
    
  

  <p>We can now finally start with writing the first-step of our fluid simulator, the advection scheme.</p>

<h2 id="classical-advection-scheme">Classical Advection Scheme</h2>

<p>As we discussed earlier, advection is the process by which some fluid property is moved by the velocity of the fluid. Even the velocities themselves are moved each simulation step by their own velocity.</p>

<p>Describing the classical advection scheme using this information because very simple. Suppose we want to advect the velocities of the fluid (that means we want to move the position of the velocities, by the velocity themselves):</p>

<script src="assets/mermaid-js/mermaid-v11.20.js"></script>
<div class="mermaid">
flowchart LR
	id1["Look up velocity $\vec{v}$ at current position $\vec{p}$"]
	id2["Add velocity multiplied by time-step to current position: $$\vec{p}_{\text{new}} = \vec{p} + \vec{v} \cdot \Delta t$$"]
	id3["Look up the velocity at $\vec{p}_{\text{new}}$"]
	id4["Change the velocity at $\vec{p}_{\text{new}}$ to $\vec{v}$"]

	id1 e1@==&gt; id2
	id2 e2@==&gt; id3
	id3 e3@==&gt; id4

	e1@{ animate: true, animation: fast }
	e2@{ animate: true, animation: fast }
	e3@{ animate: true, animation: fast }
</div>

<h3 id="issues-with-classical-advection-scheme">Issues with Classical Advection Scheme</h3>

<p>This approach is unsuitable for our needs for a few reasons:</p>

<ol>
  <li>This scheme is highly unsuitable for GPU implementation because it means that multiple GPU <span class="jekyll-glossary">  invocations  <span class="jekyll-glossary-tooltip">    <span class="jekyll-glossary-tooltip-hidden">(</span>(A.K.A. thread or GPU work unit) The smallest unit of GPU execution within a kernel function. For GPGPU programming, invocations are organized into 3D grids and are dispatched in batches called “workgroups”.<br /><a class="jekyll-glossary-source-link" href="https://docs.modular.com/glossary/gpu/thread/" target="_blank"></a><span class="jekyll-glossary-tooltip-hidden">)</span>  </span></span> can write to the same pixel. We want each pixel to be updated by one GPU <span class="jekyll-glossary">  invocation  <span class="jekyll-glossary-tooltip">    <span class="jekyll-glossary-tooltip-hidden">(</span>(A.K.A. thread or GPU work unit) The smallest unit of GPU execution within a kernel function. For GPGPU programming, invocations are organized into 3D grids and are dispatched in batches called “workgroups”.<br /><a class="jekyll-glossary-source-link" href="https://docs.modular.com/glossary/gpu/thread/" target="_blank"></a><span class="jekyll-glossary-tooltip-hidden">)</span>  </span></span> at most.</li>
  <li>The new lookup position $\vec{p}_{\text{new}}$ will very likely not lie exactly on a pixel center, so the location you are trying to write to is actually an interpolation of nearby pixels, which means you will have to update multiple pixels at once.</li>
</ol>

<h2 id="stams-advection-scheme">Stam’s Advection Scheme</h2>

<p>A staple of writing your first real-time fluid simulator is reading the amazing paper by <a class="citation" href="/shader-compendium/references.html#stam_real-time_2003">Stam (2003)</a>. Stam describes a different approach to advection that is much more suited to be implemented on the GPU:</p>

<ol>
  <li>Read the velocity $\vec{v}$ at the current position $\vec{p}$</li>
  <li>Look “backwards” using this velocity: $\vec{p}_{\text{new}} = \vec{p} - \vec{v} \cdot \Delta t$</li>
  <li>Look up the velocity at $\vec{p}_{\text{new}}$</li>
  <li>Copy that velocity to the current position</li>
</ol>

<p>It is very likely that $\vec{p}_{\text{new}}$ will not be located exactly on a pixel center, so instead, look up the 4 nearest pixels and perform a <a href="https://en.wikipedia.org/wiki/Bilinear_interpolation">bilinear interpolation</a>* to calculate the new velocity value.</p>

<p>If that’s difficult to visualize, I have made an animation to hopefully illustrate this advection scheme better:</p>

<video loop="" style="width: 100%; height: auto;" autoplay="" controls="">
  <source src="assets/videos/chapter060/FluidAdvection.mp4" type="video/mp4" />
  Your browser does not support the video tag.
</video>

<p>*You only need to do bilinear interpolation if you are looking up the values of the velocity texture using texel positions. If you are using a <code class="language-plaintext highlighter-rouge">sampler2D</code> and looking up values by UV coordinates instead, then all you need to do is ensure that your <code class="language-plaintext highlighter-rouge">sampler2D</code> is configured with bilinear filtering enabled and it will be done automatically for you!</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// If you are using any of these methods to look up values</span>
<span class="c1">// then you need to do bilinear filtering yourself:</span>
<span class="n">texelFetch</span><span class="p">(</span><span class="n">VELOCITY_TEXTURE</span><span class="p">,</span> <span class="n">texel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">imageLoad</span><span class="p">(</span><span class="n">VELOCITY_IMAGE</span><span class="p">,</span> <span class="n">texel</span><span class="p">);</span>

<span class="c1">// If you are using a sampler, simply set up the sampler with bilinear filtering:</span>
<span class="n">texture</span><span class="p">(</span><span class="n">VELOCITY_TEXTURE</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
<span class="n">texture</span><span class="p">(</span><span class="n">VELOCITY_TEXTURE</span><span class="p">,</span> <span class="n">texel</span> <span class="o">/</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">));</span>
</code></pre></div></div>


  
</section>


  <div class="chapter-pager">

    
      
      <a
        href="/shader-compendium/references.html"
        class="chapter-next "
        aria-label="Next page: References"
        data-level="1.1"
        data-path="/shader-compendium/references.html">
        <div class="pager-arrow">
          <i class="fa fa-arrow-right"></i>
        </div>
        <div class="pager-labels">
          <div class="part">
            Next:
            
              
              
            
          </div>
          <div class="chapter-label">
            References
          </div>
        </div>
      </a>
    

    
      
      <a
        href="/shader-compendium/helmholtz-hodge-decomposition.html"
        class="chapter-prev "
        aria-label="Previous page: Helmholtz-Hodge Decomposition"
        data-level="1.1"
        data-path="/shader-compendium/helmholtz-hodge-decomposition.html">
        <div class="pager-arrow">
          <i class="fa fa-arrow-left"></i>
        </div>
        <div class="pager-labels">
          <div class="part">
            Previous:
            
              
                Gpu fluids
                &#8250;
              
              Chapter 8.
            
          </div>
          <div class="chapter-label">
            Helmholtz-Hodge Decomposition
          </div>
        </div>
      </a>
    

    <div style="clear: both;"></div>
  </div>
  <!-- .chapter-pager -->

 
						</div>
						<!-- .page-inner -->
					</div>
					<!-- .page-wrapper -->
				</div>
				<!-- .body-inner -->
				<div class="page-footer">
					 
					<div class="bottom-nav">
						    
						<a href="/shader-compendium/index.html"> Home </a>
						  -    
						<a href="/shader-compendium/book.html"> Book </a>
						  -    
						<a href="https://github.com/nekotogd"> GitHub </a>
						  -    
						<a href="/shader-compendium/privacy.html"> Privacy </a>
						
					</div>
					 
					<div class="copyright">
						  
						<a href="/shader-compendium/book.html">
							 &copy;   2024- 2025 NekotoArts 
						</a>
						
					</div>
					
				</div>
				<!-- .chapter-footer -->
			</div>
			<!-- .book-body -->
		</div>
		<!-- .book --><!--
<script src="/shader-compendium/assets/chapterbook/require.js"></script>
<script src="/shader-compendium/assets/chapterbook/jquery-3.6.0.min.js"></script>
-->

<script src="/shader-compendium/assets/gitbook/gitbook.js"></script>
<script src="/shader-compendium/assets/gitbook/theme.js"></script>

<script src="/shader-compendium/assets/chapterbook/chapterbook.js"></script>

<script src="/shader-compendium/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>

<!--
<script src="/shader-compendium/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>
-->

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<!-- // JG
<script src="/shader-compendium/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/shader-compendium/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
-->
<script src="/shader-compendium/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>

<!--
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
-->


<script>
			// var gitbook = gitbook || [];
			gitbook.push(function() {
			  gitbook.page.hasChanged({
  "page": {
    "title": "Introduction",
    "level": "1.1",
    "depth": 1,
    "dir": "ltr"
  },

  "config": {
   "plugins": ["fontsettings"],
    "styles": {
      "ebook": "styles/ebook.css",
      "epub": "styles/epub.css",
      "mobi": "styles/mobi.css",
      "pdf": "styles/pdf.css",
      "print": "styles/print.css",
      "website": "styles/website.css"
    },
    "pluginsConfig": {
      "fontsettings": {
        "family": "sans",
        "size": 2,
        "theme": "white"
      },
      "theme-default": {
        "showLevel": false,
        "styles": {
          "ebook": "styles/ebook.css",
          "epub": "styles/epub.css",
          "mobi": "styles/mobi.css",
          "pdf": "styles/pdf.css",
          "print": "styles/print.css",
          "website": "styles/website.css"
        }
      }
    },
    "theme": "default",
    "author": "",
    "pdf": {
      "pageNumbers": true,
      "fontSize": 12,
      "fontFamily": "Arial",
      "paperSize": "a4",
      "chapterMark": "pagebreak",
      "pageBreaksBefore": "/",
      "margin": {
        "right": 62,
        "left": 62,
        "top": 56,
        "bottom": 56
      }
    },
    "structure": {
      "langs": "LANGS.md",
      "readme": "README.md",
    },
    "variables": {},
    "title": "Shader Compendium",
    "language": "en",
    "gitbook": "*"
  },
  "file": {
    "path": "_chapters/060-GPU-fluids/040-jos-stam-advection-scheme.md",
    "mtime": "2025-10-15 23:22:09 +0400",
    "type": "markdown"
  },
  "gitbook": {
    "version": "",
    "time": "2025-10-15 23:22:09 +0400"
  },
  "basePath": "/shader-compendium",
  "book": {
    "language": ""
  }
}
);
			});
		</script>

		<script src="/shader-compendium/assets/js-custom/glsl-extra-keywords.js"></script>
	</body>
</html>
