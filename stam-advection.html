<!DOCTYPE html>
<html lang="en">
	<head>
		
<!--KaTeX-->
<link
	rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
	integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
	crossorigin="anonymous"
/>
<script
	defer
	src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
	integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4"
	crossorigin="anonymous"
></script>
<script
	defer
	src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
	integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa"
	crossorigin="anonymous"
></script>
<script>
	document.addEventListener("DOMContentLoaded", function () {
		renderMathInElement(document.body, {
			// customised options
			// • auto-render specific keys, e.g.:
			delimiters: [
				{ left: "$$", right: "$$", display: true },
				{ left: "$", right: "$", display: false },
				{ left: "\\(", right: "\\)", display: false },
				{ left: "\\[", right: "\\]", display: true },
			],
			// • rendering keys, e.g.:
			throwOnError: false,
		});
	});
</script>

<!-- GLSL Canvas -->
<script
	type="text/javascript"
	src="https://unpkg.com/glsl-canvas-js/dist/umd/glsl-canvas.min.js"
></script>

<!-- Jekyll Chapterbook guy took out syntax highlighting idky -->
<link rel="stylesheet" href="/shader-compendium/assets/gitbook/rouge/nekoto_theme.css">

<meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Jos Stam Advection Scheme · Shader Compendium</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="A collection of chapters to help you better understand the world of shaders">

<meta name="generator" content="Jekyll (using jekyll-chapterbook theme)"><meta name="author" content="NekotoArts"><link rel="stylesheet" href="/shader-compendium/assets/gitbook/style.css">
<link rel="stylesheet" href="/shader-compendium/assets/gitbook/gitbook-plugin-fontsettings/website.css"><!--
  <link rel="stylesheet" href="/shader-compendium/assets/gitbook/gitbook-plugin-search-pro/search.css">
  <link rel="stylesheet" href="/shader-compendium/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">
  <link rel="stylesheet" href="/shader-compendium/assets/gitbook/rouge/nekoto_theme.css">
  --><link rel="stylesheet" href="/shader-compendium/assets/gitbook/custom.css">
<link rel="stylesheet" href="/shader-compendium/assets/chapterbook/chapterbook.css">

<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<!--
<link
  rel="apple-touch-icon-precomposed"
  sizes="152x152"
  href="/shader-compendium/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
-->
  
<link
  rel="shortcut icon"
  href="/shader-compendium/assets/gitbook/images/favicon.ico"
  type="image/x-icon">


<link rel="stylesheet" href="/shader-compendium/assets/extra.css">



<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
		<link rel="canonical" href="https://nekotoarts.github.io/shader-compendium/stam-advection.html" />
		  
		<link rel="prev" href="/shader-compendium/helmholtz-hodge-decomposition.html" />
		 
		<link rel="next" href="/shader-compendium/references.html" />
		 
	</head>
	<body>
		<div class="book">
			
  <div class="book-summary">
    <nav role="navigation">
      <ul class="summary chapter-summary">

        
          
            
            
            
            <li class="chapter ">
              <a href="/shader-compendium/index.html" class="">The Shader Compendium</a>
            </li>
          
          <li class="divider"></li>
        

        



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/book.html">
              
              Book Information
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/contents.html">
              
              Table of Contents
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          
            <li class="header ">
              
              Part 1: The basics
              
            </li>
          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/what-are-shaders.html">
              
                1.
              
              What are Shaders?
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/gpu-design.html">
              
                2.
              
              The GPU Design
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          
            <li class="header ">
              
              Part 2: Realtime rendering
              
            </li>
          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/rendering-equation.html">
              
                3.
              
              The Rendering Equation
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/solving-rendering-equation.html">
              
                4.
              
              Solving the Rendering Equation
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/rasterization.html">
              
                5.
              
              Rasterization
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

          
          
            
          

          

          
            <li class="header ">
              
              Part 6: Gpu fluids
              
            </li>
          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/navier-stokes-finite-difference.html">
              
                6.
              
              Navier-Stokes Equations and FDM
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/fluids-high-level-solution.html">
              
                7.
              
              High-Level Solution Overview
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/helmholtz-hodge-decomposition.html">
              
                8.
              
              Helmholtz-Hodge Decomposition
            </a>

            
              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            














          

          

          

          

          
            <li class="chapter active">
          

            <a href="/shader-compendium/stam-advection.html">
              
                9.
              
              Jos Stam Advection Scheme
            </a>

            
              
                <ul><li><a href="#gpu-data-structures-and-operations">GPU Data Structures and Operations</a><ul><li><a href="#eulerian-data-on-the-gpu">Eulerian Data on the GPU</a></li><li><a href="#slab-operations">Slab Operations</a></li></ul></li><li><a href="#classical-advection-scheme">Classical Advection Scheme</a><ul><li><a href="#issues-with-classical-advection-scheme">Issues with Classical Advection Scheme</a></li></ul></li><li><a href="#stams-advection-scheme">Stam’s Advection Scheme</a><ul><li><a href="#issues-with-stams-advection-scheme">Issues with Stam’s Advection Scheme</a></li></ul></li><li><a href="#a-note-on-alternatives">A Note on Alternatives</a></li></ul>

              
            
          </li>

          



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





        

          
          
            
              














            
          

          

          

          

          
            <li class="chapter ">
          

            <a href="/shader-compendium/references.html">
              
              References
            </a>

            
              
            
          </li>

          



















  
  


















        

          
          
            
          

          
            



















  
  
  
  
  
  
  

  
  
  
  

  
  
  
  

  

  





            

        
          <li class="divider"></li>
          
            
            
            
            <li class="chapter ">
              <a href="/shader-compendium/outline.html" class="">Book Outline</a>
            </li>
          
            
            
            
            <li class="chapter ">
              <a href="https://github.com/nekotoarts/shader-compendium/" class="">Star on GitHub</a>
            </li>
          
        

      </ul>
    </nav>
  </div>
  

			<div class="book-body">
				<div class="book-header" role="navigation">
					
					<a
						href="https://github.com/nekotoarts/shader-compendium/edit/main/_chapters/060-GPU-fluids/040-jos-stam-advection-scheme.md"
						target="_blank"
						title="Edit on GitHub"
						class="github-edit-link"
					>
						<i class="fa fa-github"></i>
					</a>
					
					<h1>
						<a href="/shader-compendium/index.html"
							>Shader Compendium</a
						>
					</h1>
				</div>
				<!-- .book-header -->

				<div class="body-inner">
					<!-- introduce per-page mermaid support -->
					<!--  -->
					<div class="page-wrapper" tabindex="-1" role="main">
						<div
							class="page-inner "
						>
							 




  <nav aria-label="Breadcrumb" class="breadcrumb markdown-section">
    <ul>
      
        
          <li>
              
              <a href="/shader-compendium/book.html">
            
              <img class="book-icon" src="/shader-compendium/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
              Book
            
              </a>
            
          </li>
      

      
        
        <li >
          
            <a href="/shader-compendium/contents.html">
          
            Contents
          
            </a>
          
        </li>
      

      

      
        

          
            
              <li class="breadcrumb-part">
                
                Part 6: Gpu fluids
                
              </li>
            
          

          
            <li class="no-arrow">
              Chapter 9.
            </li>
          

        
      
    </ul>
  </nav>

  
    <h1
      id="stam-advection"
      data-level="1.1"
      class="heading-chapter-title no_toc">Jos Stam Advection Scheme</h1>
  


<section class="normal markdown-section">

  

  
    
    

    
      <div class="page-toc">
        <div class="page-toc-heading">
          In this chapter:
          <ul><li><a href="#gpu-data-structures-and-operations">GPU Data Structures and Operations</a><ul><li><a href="#eulerian-data-on-the-gpu">Eulerian Data on the GPU</a></li><li><a href="#slab-operations">Slab Operations</a></li></ul></li><li><a href="#classical-advection-scheme">Classical Advection Scheme</a><ul><li><a href="#issues-with-classical-advection-scheme">Issues with Classical Advection Scheme</a></li></ul></li><li><a href="#stams-advection-scheme">Stam’s Advection Scheme</a><ul><li><a href="#issues-with-stams-advection-scheme">Issues with Stam’s Advection Scheme</a></li></ul></li><li><a href="#a-note-on-alternatives">A Note on Alternatives</a></li></ul>
        </div>
      </div>
    
  

  <p>We can now finally start with writing the first-step of our fluid simulator, the advection scheme. In order to implement this on the GPU as shaders, we need to review some information about GPU architecture so we can come up with an appropriate way to store and operate on our data.</p>

<h2 id="gpu-data-structures-and-operations">GPU Data Structures and Operations</h2>

<p>Whether you choose to implement the fluid simulator using compute shaders or fragment shaders is entirely up to you.</p>

<h3 id="eulerian-data-on-the-gpu">Eulerian Data on the GPU</h3>

<p>Since we are doing an Eulerian simulation (which just means that it is a grid-based simulation), it makes sense to store our data in textures. For a fragment program, the position of the fragment would represent the position in the grid you are working on, and for a compute program, the <span class="jekyll-glossary">  invocation  <span class="jekyll-glossary-tooltip">    <span class="jekyll-glossary-tooltip-hidden">(</span>(A.K.A. thread or GPU work unit) The smallest unit of GPU execution within a kernel function. For GPGPU programming, invocations are organized into 3D grids and are dispatched in batches called “workgroups”.<br /><a class="jekyll-glossary-source-link" href="https://docs.modular.com/glossary/gpu/thread/" target="_blank"></a><span class="jekyll-glossary-tooltip-hidden">)</span>  </span></span> index would tell you what position in the grid you are working on.</p>

<p>Alternatively, for a compute program you could also store the data in a 1D buffer and calculate the buffer index from the grid position. The benefit of doing this is the freedom to store more data. In a texture you only get up to 4 channels to store data to for each cell, however, a compute buffer can store contains structs of larger sizes making it easier to store data.</p>

<script src="assets/mermaid-js/mermaid-v11.20.js"></script>
<div class="mermaid">
block
	columns 5
	0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24
</div>

<p>You can get around the problem of texture storage space being limited to 4-channels by simply adding more textures to your shader of course. In this book we assume the use of textures as they make our explanations easier to understand.</p>

<h3 id="slab-operations">Slab Operations</h3>

<p>Every step that we are going to carry out in our fluid simulation (advection, diffusion, external forces, projection, etc.) is going to be carried out as a slab operation (often abbreviated as slabop).</p>

<p>A slab operation involves reading all of the old simulation data in parallel, computing the new values, writing the new values to a <strong>separate</strong> temporary texture, and finally copying the data from this new texture into the original texture (which is called a texture update). This can be summarized as:</p>

<ol>
  <li>Read old values</li>
  <li>Calculate new values</li>
  <li>Write new values to temporary storage</li>
  <li>After all new values are written to temporary storage, copy this data to original buffer</li>
</ol>

<h2 id="classical-advection-scheme">Classical Advection Scheme</h2>

<p>As we discussed earlier, advection is the process by which some fluid property is moved by the velocity of the fluid. Even the velocities themselves are moved each simulation step by their own velocity.</p>

<p>Describing the classical advection scheme using this information because very simple. Suppose we want to advect the velocities of the fluid (that means we want to move the position of the velocities, by the velocity itself):</p>

<script src="assets/mermaid-js/mermaid-v11.20.js"></script>
<div class="mermaid">
flowchart TD
	id1["Look up velocity $\vec{v}$ at current position $\vec{p}$"]
	id2["Add velocity multiplied by time-step to current position: $$\vec{p}_{\text{new}} = \vec{p} + \vec{v} \cdot \Delta t$$"]
	id3["Look up the velocity at $\vec{p}_{\text{new}}$"]
	id4["Change the velocity at $\vec{p}_{\text{new}}$ to $\vec{v}$"]

	id1 e1@==&gt; id2
	id2 e2@==&gt; id3
	id3 e3@==&gt; id4

	e1@{ animate: true, animation: fast }
	e2@{ animate: true, animation: fast }
	e3@{ animate: true, animation: fast }
</div>

<h3 id="issues-with-classical-advection-scheme">Issues with Classical Advection Scheme</h3>

<p>This approach is unsuitable for our needs for a few reasons:</p>

<ol>
  <li>This scheme is highly unsuitable for GPU implementation because it means that multiple GPU <span class="jekyll-glossary">  invocations  <span class="jekyll-glossary-tooltip">    <span class="jekyll-glossary-tooltip-hidden">(</span>(A.K.A. thread or GPU work unit) The smallest unit of GPU execution within a kernel function. For GPGPU programming, invocations are organized into 3D grids and are dispatched in batches called “workgroups”.<br /><a class="jekyll-glossary-source-link" href="https://docs.modular.com/glossary/gpu/thread/" target="_blank"></a><span class="jekyll-glossary-tooltip-hidden">)</span>  </span></span> can write to the same pixel. We want each pixel to be updated by one GPU <span class="jekyll-glossary">  invocation  <span class="jekyll-glossary-tooltip">    <span class="jekyll-glossary-tooltip-hidden">(</span>(A.K.A. thread or GPU work unit) The smallest unit of GPU execution within a kernel function. For GPGPU programming, invocations are organized into 3D grids and are dispatched in batches called “workgroups”.<br /><a class="jekyll-glossary-source-link" href="https://docs.modular.com/glossary/gpu/thread/" target="_blank"></a><span class="jekyll-glossary-tooltip-hidden">)</span>  </span></span> at most.</li>
  <li>The new lookup position $\vec{p}_{\text{new}}$ will very likely not lie exactly on a pixel center, so the location you are trying to write to is actually an interpolation of nearby pixels, which means you will have to update multiple pixels at once.</li>
</ol>

<h2 id="stams-advection-scheme">Stam’s Advection Scheme</h2>

<p>A staple of writing your first real-time fluid simulator is reading the amazing paper by <a class="citation" href="/shader-compendium/references.html#stam_real-time_2003">Stam (2003)</a>. Stam describes a different approach to advection that is much more suited to be implemented on the GPU:</p>

<ol>
  <li>Read the velocity $\vec{v}$ at the current position $\vec{p}$</li>
  <li>Look “backwards” using this velocity: $\vec{p}_{\text{new}} = \vec{p} - \vec{v} \cdot \Delta t$</li>
  <li>Look up the velocity at $\vec{p}_{\text{new}}$</li>
  <li>Copy that velocity and use it as the new velocity for that point</li>
</ol>

<p>It is very likely that $\vec{p}_{\text{new}}$ will not be located exactly on a pixel center, so instead, look up the 4 nearest pixels and perform a <a href="https://en.wikipedia.org/wiki/Bilinear_interpolation">bilinear interpolation</a>* to calculate the new velocity value.</p>

<p>If that’s difficult to visualize, I have made an animation to hopefully illustrate this advection scheme better. You can also see how part of the slab operation is performed, after this the “new velocity texture” data is copied to the “old velocity texture” so the calculation can be re-run with the new data on the next time step:</p>

<video loop="" style="width: 100%; height: auto;" autoplay="" controls="">
  <source src="assets/videos/chapter060/FluidAdvection.mp4" type="video/mp4" />
  Your browser does not support the video tag.
</video>

<p>*You only need to do bilinear interpolation if you are looking up the values of the velocity texture using texel positions. If you are using a <code class="language-plaintext highlighter-rouge">sampler2D</code> and looking up values by UV coordinates instead, then all you need to do is ensure that your <code class="language-plaintext highlighter-rouge">sampler2D</code> is configured with bilinear filtering enabled and it will be done automatically for you!</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// If you are using any of these methods to look up values</span>
<span class="c1">// then you need to do bilinear filtering yourself:</span>
<span class="n">texelFetch</span><span class="p">(</span><span class="n">VELOCITY_TEXTURE</span><span class="p">,</span> <span class="n">texel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">imageLoad</span><span class="p">(</span><span class="n">VELOCITY_IMAGE</span><span class="p">,</span> <span class="n">texel</span><span class="p">);</span>

<span class="c1">// If you are using a sampler, simply set up the sampler with bilinear filtering:</span>
<span class="n">texture</span><span class="p">(</span><span class="n">VELOCITY_TEXTURE</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
<span class="n">texture</span><span class="p">(</span><span class="n">VELOCITY_TEXTURE</span><span class="p">,</span> <span class="n">texel</span> <span class="o">/</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">-</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">));</span>
</code></pre></div></div>

<blockquote>
  <p>This type of advection scheme is called a semi-Lagrangian advection scheme. Lagrangian simulations are fluid simulations where the fluid is composed of simulated particles. On the other hand, what we are doing is called an Eulerian simulation, where our simulation data exists on a fixed grid. So the term semi-Lagrangian means that we pretend / imagine that there are particles in our fluid and evaluate their behavior, but we never actually store these particles as data anywhere. We are simply using the “concept” of particles.</p>
</blockquote>

<p>Stam’s advection scheme is a better approach for two reasons:</p>

<ol>
  <li>It is very well suited for implementation on the GPU</li>
  <li>It is unconditionally stable, which means that you can use it even when the time-step is large.</li>
</ol>

<h3 id="issues-with-stams-advection-scheme">Issues with Stam’s Advection Scheme</h3>

<p>Consider running Stam’s advection scheme on the following case. Here is an example current velocity texture:</p>

<script src="assets/mermaid-js/mermaid-v11.20.js"></script>
<div class="mermaid">
block
	columns 5
	0["0"] 1["0"] 2["0"] 3["0"] 4["0"]
	5["0"] 6["0"] 7["0"] 8["0"] 9["0"]
	10["0"] 11["0"] 12["$\rightarrow$"] 13["0"] 14["0"]
	15["0"] 16["0"] 17["0"] 18["0"] 19["0"]
	20["0"] 21["0"] 22["0"] 23["0"] 24["0"]
</div>

<p>Only the center grid position has a velocity pointing to the right, the rest of the grid positions don’t have any velocity (represented in the diagram as “0”).</p>

<p>For all the positions with zero velocity, their lookup position is identical to their current position, which means their output velocity will also still be zero.</p>

<p>However, for the center grid position, it inverts it’s velocity, looks up the values to the left (which are all zero), and copies that velocity, resulting in the following output:</p>

<script src="assets/mermaid-js/mermaid-v11.20.js"></script>
<div class="mermaid">
block
	columns 5
	0["0"] 1["0"] 2["0"] 3["0"] 4["0"]
	5["0"] 6["0"] 7["0"] 8["0"] 9["0"]
	10["0"] 11["0"] 12["0"] 13["0"] 14["0"]
	15["0"] 16["0"] 17["0"] 18["0"] 19["0"]
	20["0"] 21["0"] 22["0"] 23["0"] 24["0"]
</div>

<p>This is obviously incorrect, as advection tells us that the velocity must move by the velocity itself. So the correct result should be something like this:</p>

<script src="assets/mermaid-js/mermaid-v11.20.js"></script>
<div class="mermaid">
block
	columns 5
	0["0"] 1["0"] 2["0"] 3["0"] 4["0"]
	5["0"] 6["0"] 7["0"] 8["0"] 9["0"]
	10["0"] 11["0"] 12["0"] 13["$\rightarrow$"] 14["0"]
	15["0"] 16["0"] 17["0"] 18["0"] 19["0"]
	20["0"] 21["0"] 22["0"] 23["0"] 24["0"]
</div>

<p>So what’s going on here? Why does Stam’s advection scheme work for simple fluid simulations if it gives us an obviously incorrect answer here? Take a moment to think about it.</p>

<p>The devil lies in the example problem itself. The example I have given you here is not a valid simulation state in the first place <img src="/shader-compendium/assets/emoji/dogekek.png" class="emoji" />. Recall our incompressibility condition we discussed with the Navier-Stokes equations:</p>

<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∇</mi><mo>⋅</mo><mover accent="true"><mi>u</mi><mo>⃗</mo></mover><mo>=</mo><mn>0</mn><mtext>  </mtext><mtext>(Incompressible Flow)</mtext></mrow><annotation encoding="application/x-tex">\nabla \cdot \vec{u} = 0 \; \textrm{(Incompressible Flow)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">∇</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.714em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">u</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord textrm">(Incompressible Flow)</span></span></span></span></span></span>

<p>It states that the divergence of the velocity field must always be zero. Divergence is a measure of how much the vectors of a vector field are “flowing out” of a certain point. <a href="/shader-compendium/fluids-high-level-solution.html#incompressibility-condition-reviewed">Look back at this chapter for a review</a>. A non-zero divergence means that matter is either being created or destroyed, which violates the law of conservation of mass.</p>

<p>If you look at the example above, it is not possible for the center grid cell to have a non-zero velocity value when all of it’s neighbors are zero. That means that there is fluid flowing out of that cell without any fluid entering that cell, which means matter is being mysteriously created there. A valid example might look something like this instead:</p>

<script src="assets/mermaid-js/mermaid-v11.20.js"></script>
<div class="mermaid">
block
	columns 5
	0["0"] 1["0"] 2["0"] 3["0"] 4["0"]
	5["0"] 6["$\swarrow$"] 7["$\leftarrow$"] 8["$\nwarrow$"] 9["0"]
	10["0"] 11["$\searrow$"] 12["$\rightarrow$"] 13["$\nearrow$"] 14["0"]
	15["0"] 16["0"] 17["0"] 18["0"] 19["0"]
	20["0"] 21["0"] 22["0"] 23["0"] 24["0"]
</div>

<p>Notice how the velocities flow into each other so that the velocity field has no divergence.</p>

<p>When we get to the later parts of our simulator where we employ the Helmholtz-Hodge decomposition to obtain a divergence-free velocity field, Stam’s advection scheme works much better and proves to be a simple yet efficient advection model.</p>

<h2 id="a-note-on-alternatives">A Note on Alternatives</h2>

<p>Keep in mind that other advection schemes also exist. Many are a lot more accurate than Stam’s advection scheme, however, Stam’s is one of the simplest to understand and easiest to implement.</p>

<p>After we have completed building a basic fluid simulator we will explore a different, more accurate advection scheme that you can choose to replace Stam’s advection scheme with.</p>


  
</section>


  <div class="chapter-pager">

    
      
      <a
        href="/shader-compendium/references.html"
        class="chapter-next "
        aria-label="Next page: References"
        data-level="1.1"
        data-path="/shader-compendium/references.html">
        <div class="pager-arrow">
          <i class="fa fa-arrow-right"></i>
        </div>
        <div class="pager-labels">
          <div class="part">
            Next:
            
              
              
            
          </div>
          <div class="chapter-label">
            References
          </div>
        </div>
      </a>
    

    
      
      <a
        href="/shader-compendium/helmholtz-hodge-decomposition.html"
        class="chapter-prev "
        aria-label="Previous page: Helmholtz-Hodge Decomposition"
        data-level="1.1"
        data-path="/shader-compendium/helmholtz-hodge-decomposition.html">
        <div class="pager-arrow">
          <i class="fa fa-arrow-left"></i>
        </div>
        <div class="pager-labels">
          <div class="part">
            Previous:
            
              
                Gpu fluids
                &#8250;
              
              Chapter 8.
            
          </div>
          <div class="chapter-label">
            Helmholtz-Hodge Decomposition
          </div>
        </div>
      </a>
    

    <div style="clear: both;"></div>
  </div>
  <!-- .chapter-pager -->

 
						</div>
						<!-- .page-inner -->
					</div>
					<!-- .page-wrapper -->
				</div>
				<!-- .body-inner -->
				<div class="page-footer">
					 
					<div class="bottom-nav">
						    
						<a href="/shader-compendium/index.html"> Home </a>
						  -    
						<a href="/shader-compendium/book.html"> Book </a>
						  -    
						<a href="https://github.com/nekotogd"> GitHub </a>
						  -    
						<a href="/shader-compendium/privacy.html"> Privacy </a>
						
					</div>
					 
					<div class="copyright">
						  
						<a href="/shader-compendium/book.html">
							 &copy;   2024- 2025 NekotoArts 
						</a>
						
					</div>
					
				</div>
				<!-- .chapter-footer -->
			</div>
			<!-- .book-body -->
		</div>
		<!-- .book --><!--
<script src="/shader-compendium/assets/chapterbook/require.js"></script>
<script src="/shader-compendium/assets/chapterbook/jquery-3.6.0.min.js"></script>
-->

<script src="/shader-compendium/assets/gitbook/gitbook.js"></script>
<script src="/shader-compendium/assets/gitbook/theme.js"></script>

<script src="/shader-compendium/assets/chapterbook/chapterbook.js"></script>

<script src="/shader-compendium/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>

<!--
<script src="/shader-compendium/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>
-->

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<!-- // JG
<script src="/shader-compendium/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/shader-compendium/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
-->
<script src="/shader-compendium/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>

<!--
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
-->


<script>
			// var gitbook = gitbook || [];
			gitbook.push(function() {
			  gitbook.page.hasChanged({
  "page": {
    "title": "Introduction",
    "level": "1.1",
    "depth": 1,
    "dir": "ltr"
  },

  "config": {
   "plugins": ["fontsettings"],
    "styles": {
      "ebook": "styles/ebook.css",
      "epub": "styles/epub.css",
      "mobi": "styles/mobi.css",
      "pdf": "styles/pdf.css",
      "print": "styles/print.css",
      "website": "styles/website.css"
    },
    "pluginsConfig": {
      "fontsettings": {
        "family": "sans",
        "size": 2,
        "theme": "white"
      },
      "theme-default": {
        "showLevel": false,
        "styles": {
          "ebook": "styles/ebook.css",
          "epub": "styles/epub.css",
          "mobi": "styles/mobi.css",
          "pdf": "styles/pdf.css",
          "print": "styles/print.css",
          "website": "styles/website.css"
        }
      }
    },
    "theme": "default",
    "author": "",
    "pdf": {
      "pageNumbers": true,
      "fontSize": 12,
      "fontFamily": "Arial",
      "paperSize": "a4",
      "chapterMark": "pagebreak",
      "pageBreaksBefore": "/",
      "margin": {
        "right": 62,
        "left": 62,
        "top": 56,
        "bottom": 56
      }
    },
    "structure": {
      "langs": "LANGS.md",
      "readme": "README.md",
    },
    "variables": {},
    "title": "Shader Compendium",
    "language": "en",
    "gitbook": "*"
  },
  "file": {
    "path": "_chapters/060-GPU-fluids/040-jos-stam-advection-scheme.md",
    "mtime": "2025-10-16 13:19:51 +0400",
    "type": "markdown"
  },
  "gitbook": {
    "version": "",
    "time": "2025-10-16 13:19:51 +0400"
  },
  "basePath": "/shader-compendium",
  "book": {
    "language": ""
  }
}
);
			});
		</script>

		<script src="/shader-compendium/assets/js-custom/glsl-extra-keywords.js"></script>
	</body>
</html>
